# Deployment Guide

This document describes the automated CI/CD pipeline for the Daily Expense Tracker application using GitHub Actions and Firebase.

## Overview

The deployment pipeline automatically:
- Runs tests and linting on all PRs and pushes
- Builds and deploys to Firebase Hosting on pushes to `main` branch
- Deploys Firestore security rules
- Provides deployment URLs and status

## GitHub Actions Workflow

The workflow (`.github/workflows/deploy.yml`) consists of two jobs:

### 1. Test Job
- Runs on all pushes and pull requests
- Installs dependencies
- Runs ESLint linting
- Executes Vitest test suite

### 2. Build and Deploy Job
- Only runs on pushes to `main` branch after tests pass
- Builds the application for production
- Deploys to Firebase Hosting
- Updates Firestore security rules

## Required GitHub Secrets

To enable the deployment workflow, configure the following secrets in your GitHub repository:

### Firebase Configuration Secrets
Add these in **GitHub Repository Settings > Secrets and Variables > Actions**:

| Secret Name | Description | Example Value |
|-------------|-------------|---------------|
| `VITE_FIREBASE_API_KEY` | Firebase API Key | `AIzaSyC...` |
| `VITE_FIREBASE_AUTH_DOMAIN` | Firebase Auth Domain | `your-project.firebaseapp.com` |
| `VITE_FIREBASE_PROJECT_ID` | Firebase Project ID | `daily-expense-tracker-73693` |
| `VITE_FIREBASE_STORAGE_BUCKET` | Firebase Storage Bucket | `your-project.firebasestorage.app` |
| `VITE_FIREBASE_MESSAGING_SENDER_ID` | Firebase Messaging Sender ID | `1234567890` |
| `VITE_FIREBASE_APP_ID` | Firebase App ID | `1:123:web:abc123` |
| `VITE_DAILY_BUDGET` | Daily budget amount in THB | `2000` |

### Firebase Service Account
1. **Generate Service Account Key:**
   ```bash
   # Install Firebase CLI if not already installed
   npm install -g firebase-tools
   
   # Login to Firebase
   firebase login
   
   # Generate service account key
   firebase init hosting:github
   ```

2. **Add Service Account Secret:**
   - Name: `FIREBASE_SERVICE_ACCOUNT_DAILY_EXPENSE_TRACKER_73693`
   - Value: The entire JSON content of the service account key

### Firebase Token (Alternative Method)
Instead of service account, you can use a Firebase token:

1. **Generate Firebase Token:**
   ```bash
   firebase login:ci
   ```

2. **Add Token Secret:**
   - Name: `FIREBASE_TOKEN`
   - Value: The token generated by the command above

## Setup Instructions

### 1. Configure GitHub Repository
1. Go to your GitHub repository
2. Navigate to **Settings > Secrets and Variables > Actions**
3. Add all the required secrets listed above

### 2. Get Firebase Configuration Values
1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project (`daily-expense-tracker-73693`)
3. Go to **Project Settings > General**
4. Under "Your apps", find your web app
5. Copy the config values to GitHub secrets

### 3. Generate Firebase Service Account
Option A: Using Firebase CLI (Recommended)
```bash
firebase init hosting:github
```

Option B: Manual Setup
1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Select your Firebase project
3. Go to **IAM & Admin > Service Accounts**
4. Create new service account with Firebase Admin role
5. Generate and download JSON key
6. Add JSON content to GitHub secret

### 4. Test the Workflow
1. Push a commit to the `main` branch
2. Check **Actions** tab in your GitHub repository
3. Monitor the workflow execution
4. Verify deployment at https://daily-expense-tracker-73693.web.app

## Workflow Triggers

| Event | Branch | Action |
|-------|--------|--------|
| Push | `main` | Run tests → Build → Deploy |
| Push | Other branches | Run tests only |
| Pull Request | Any → `main` | Run tests only |

## Build Process

1. **Dependencies:** `npm ci` (clean install)
2. **Linting:** `npm run lint` (ESLint checks)
3. **Testing:** `npm run test:run` (Vitest unit tests)
4. **Building:** `npm run build` (TypeScript + Vite production build)
5. **Deployment:** Firebase Hosting + Firestore rules

## Deployment URLs

After successful deployment, the application will be available at:
- **Production:** https://daily-expense-tracker-73693.web.app
- **Custom Domain:** https://expense.tholapz.com (if configured)

## Troubleshooting

### Common Issues

1. **Missing Secrets:** Ensure all required GitHub secrets are configured
2. **Firebase Permissions:** Verify service account has proper Firebase roles
3. **Build Failures:** Check Node.js version compatibility (workflow uses Node 20)
4. **Test Failures:** Fix failing tests before deployment will proceed

### Monitoring

- **GitHub Actions:** Monitor workflow runs in the Actions tab
- **Firebase Console:** Check deployment status and logs
- **Application Logs:** Monitor runtime errors in browser console

### Manual Deployment

If needed, you can still deploy manually:
```bash
npm run build
firebase deploy --only hosting
firebase deploy --only firestore:rules
```

## Security Notes

- All secrets are encrypted and only available to workflow runs
- Service account has minimal required permissions
- Build artifacts are automatically cleaned up
- No sensitive data is logged in workflow output